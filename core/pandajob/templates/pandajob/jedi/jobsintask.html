{% extends "_base_bigpandamon.html" %}{% load url from future %}{% load js %}
{% block subtitle %}List of jobs{% endblock %}
{% block header-nav-chain-1 %}<a href="{% url 'index' %}">{{ APP_NAME }}</a>{% endblock %}{% block header-nav-chain-1-separator %}{{ SEPARATOR_NAVIGATION_ITEM|safe }}{% endblock %}  
{% block header-nav-chain-2 %}<a href="{% url 'jobList' %}">List of jobs</a>{% endblock %}{% block header-nav-chain-2-separator %}{% endblock %}  
{% block header-nav-chain-3 %}{% endblock %}{% block header-nav-chain-3-separator %}{% endblock %}  
{% block header-nav-chain-4 %}{% endblock %}{% block header-nav-chain-4-separator %}{% endblock %}  
{% block header-nav-chain-5 %}{% endblock %}{% block header-nav-chain-5-separator %}{% endblock %}  
{% block header-nav-chain-6 %}{% endblock %}
{% block extra_css %}
<style type="text/css" title="currentStyle">
@import "{{ STATIC_URL }}/css/jquery.dataTables_themeroller.css";
@import "{{ STATIC_URL }}/css/jquery-ui-1.10.3.custom.min.css";
@import "{{ STATIC_URL }}/css/jquery-ui-timepicker-addon.css";
</style>
{% endblock %}
{% block extra_js %}
	<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.cookie.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.dataTables.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-ui-1.10.3.custom.min.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-ui-timepicker-addon.js"></script>

	{% django_js jquery=false i18n=true csrf=false %}

	<script type="text/javascript" charset="utf-8">
		// AJAX setup with CSRF protection
		var csrftoken = $.cookie('csrftoken');
		
		
		function csrfSafeMethod(method) {
		    // these HTTP methods do not require CSRF protection
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		
		function sameOrigin(url) {
		    // test that a given url is a same-origin URL
		    // url could be relative or scheme relative or absolute
		    var host = document.location.host; // host + port
		    var protocol = document.location.protocol;
		    var sr_origin = '//' + host;
		    var origin = protocol + sr_origin;
		    // Allow absolute or scheme relative URLs to same origin
		    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		        // or any other URL that isn't scheme relative or absolute i.e relative.
		        !(/^(\/\/|http:|https:).*/.test(url));
		}
		
		var colsOrig = {{ columns|safe }};
		var fieldIndices = {{ fieldIndices|safe }};
		
		$(document).ready(function() {
				$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
							// Send the token to same-origin, relative URLs only.
							// Send the token only if the method warrants CSRF protection
							// Using the CSRFToken value acquired earlier
							xhr.setRequestHeader("X-CSRFToken", csrftoken);
						}
					}
				});

				$('#{{ tableid_joblist }}').dataTable( {
					"bProcessing": true,
					"bServerSide": true,
					"bPaginate": true,
					"sAjaxSource": "{{ datasrc }}",
					"sServerMethod": "POST",
					"aoColumns": colsOrig, 
					"aoColumnDefs": [
						// produsername + workinggroup
						{
							"mRender": function ( data, type, row ) {
//								var a = '<a href="'
//									+ '{{ prefix }}' 
//									+ Django.url('jobInfo', {'prodUserName': data, 'nhours': 72})
//									+ '" target="_blank">' +
//									data + '</a>' +' / '+ row.workinggroup;
//								return a;
								return data + ' / ' + row.workinggroup;
							},
							"aTargets": [ fieldIndices.produsername ]
						},
						// JEDI Task ID
						{
							"mRender": function ( data, type, row ) {
							// TODO: add link to task page
								return data;
							},
							"aTargets": [ fieldIndices.jeditaskid ]
						},
						// PanDA ID
						{
							"mRender": function ( data, type, row ) {
							var a = '<a href="'
										+ '{{ prefix }}' 
										+ Django.url('jobDetails', {'pandaid': data})
									+ '" target="_blank">' + data + '</a>'
								;
								return a;
							},
							"aTargets": [ fieldIndices.pandaid ]
						},
						// Job status
						{
							"mRender": function ( data, type, row ) {
								if (data === 'failed'){
									var a = 
										'<span style="color:red;">'
										+ data
										+ '</span>';
									return a;
								} else {
									return data;
								};
							},
							"aTargets": [ fieldIndices.jobstatus ]
						},
						// Date and time format
						{
							"mRender": function ( data, type, row ) {
								if (data === ''){
									return data;
								} else {
									var d = new Date(data);
									return d.toLocaleFormat( "%m-%d %H:%M" );
								}
							},
							"aTargets": [ 
								fieldIndices.creationtime, 
								fieldIndices.modificationtime, 
								fieldIndices.starttime, 
								fieldIndices.endtime, 
							 ]
						},
						// Site+Cloud
						{
							"mRender": function ( data, type, row ) {
							// TODO: add link to site activity page
								return row.cloud + '.'+ data ;
							},
							"aTargets": [ fieldIndices.computingsite ]
						},
						{ "bVisible": false, "aTargets": [ fieldIndices.cloud ] }
					]
				} );
			} );
	</script>
{% endblock %}
{% block body %}
<table id="table-filter-{{ tableid_joblist }}" ></table>
<table id="{{ tableid_joblist }}" width="100%">
	<thead>
		<tr>
			<th width="25%">Owner</th>
			<th width="0%">WG</th>
			<th width="10%">JEDI Task ID</th>
			<th width="10%">PanDA ID</th>
			<th width="7%">Status</th>
			<th width="7%">Created</th>
			<th width="7%">Modified</th>
			<th width="7%">Start</th>
			<th width="7%">End</th>
			<th width="0%">Cloud</th>
			<th width="15%">Site</th>
			<th width="3%">Prio</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="12" class="dataTables_empty">Loading data from server</td>
		</tr>
	</tbody>
</table>
{% endblock %}
