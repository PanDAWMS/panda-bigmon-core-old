{% extends "_base_bigpandamon.html" %}{% load url from future %}{% load js %}
{% block subtitle %}List of jobs{% endblock %}
{% block header-nav-chain-1 %}<a href="{% url 'index' %}">{{ APP_NAME }}</a>{% endblock %}{% block header-nav-chain-1-separator %}{{ SEPARATOR_NAVIGATION_ITEM|safe }}{% endblock %}  
{% block header-nav-chain-2 %}<a href="{% url 'jobList' %}">List of jobs</a>{% endblock %}{% block header-nav-chain-2-separator %}{% endblock %}  
{% block header-nav-chain-3 %}{% endblock %}{% block header-nav-chain-3-separator %}{% endblock %}  
{% block header-nav-chain-4 %}{% endblock %}{% block header-nav-chain-4-separator %}{% endblock %}  
{% block header-nav-chain-5 %}{% endblock %}{% block header-nav-chain-5-separator %}{% endblock %}  
{% block header-nav-chain-6 %}{% endblock %}
{% block extra_css %}
<style type="text/css" title="currentStyle">
@import "{{ STATIC_URL }}/css/jquery.dataTables_themeroller.css";
@import "{{ STATIC_URL }}/css/jquery-ui-1.10.3.custom.min.css";
@import "{{ STATIC_URL }}/css/jquery-ui-timepicker-addon.css";
</style>
{% endblock %}
{% block extra_js %}
		<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.cookie.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.dataTables.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-ui-1.10.3.custom.min.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery-ui-timepicker-addon.js"></script>
{% comment %}
		<script type="text/javascript" src="{{ STATIC_URL }}/js/djangojs/django.js"></script>
{% endcomment %}
		{% django_js jquery=false i18n=true csrf=false %}
		<script type="text/javascript" charset="utf-8">
		// AJAX setup with CSRF protection
		var csrftoken = $.cookie('csrftoken');
		
		
		function csrfSafeMethod(method) {
		    // these HTTP methods do not require CSRF protection
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		
		function sameOrigin(url) {
		    // test that a given url is a same-origin URL
		    // url could be relative or scheme relative or absolute
		    var host = document.location.host; // host + port
		    var protocol = document.location.protocol;
		    var sr_origin = '//' + host;
		    var origin = protocol + sr_origin;
		    // Allow absolute or scheme relative URLs to same origin
		    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		        // or any other URL that isn't scheme relative or absolute i.e relative.
		        !(/^(\/\/|http:|https:).*/.test(url));
		}
		
		var colsOrig = {{ columns|safe }};
		var fieldIndices = {{ fieldIndices|safe }};
		
		$(document).ready(function() {
				$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
							// Send the token to same-origin, relative URLs only.
							// Send the token only if the method warrants CSRF protection
							// Using the CSRFToken value acquired earlier
							xhr.setRequestHeader("X-CSRFToken", csrftoken);
						}
					}
				});
			
				$('#example').dataTable( {
					"bProcessing": true,
					"bServerSide": true,
					"sAjaxSource": "{{ datasrc }}",
					"sServerMethod": "POST",
					"aoColumns": colsOrig, 
					"aoColumnDefs": [
						// produsername + workinggroup
						{
							"mRender": function ( data, type, row ) {
								return data +'/'+ row.workinggroup;
							},
							"aTargets": [ fieldIndices.produsername ]
						},
						// JEDI Task ID
						{
							"mRender": function ( data, type, row ) {
								return data;
							},
							"aTargets": [ fieldIndices.jeditaskid ]
						},
						// PanDA ID
						{
							"mRender": function ( data, type, row ) {
							var a = '<a href="'
										+ '{{ prefix }}' 
										+ Django.url('jobDetails', {'pandaid': data})
									+ '" target="_blank">' + data + '</a>'
								;
								return a;
							},
							"aTargets": [ fieldIndices.pandaid ]
						},
						// Job status
						{
							"mRender": function ( data, type, row ) {
								return data;
							},
							"aTargets": [ fieldIndices.jobstatus ]
						},
					]
				} );
			} );
		</script>  
{% endblock %}
{% block body %}
<table id="example" width="100%">
	<thead>
		<tr>
			<th>Owner</th>
			<th>WG</th>
			<th>JEDI Task ID</th>
			<th>PanDA ID</th>
			<th>Status</th>
			<th>Created</th>
			<th>Modified</th>
			<th>Start</th>
			<th>End</th>
			<th>Cloud</th>
			<th>Site</th>
			<th>Prio</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="12" class="dataTables_empty">Loading data from server</td>
		</tr>
	</tbody>
</table>
{% endblock %}
